# System Architecture Diagram: Interactive 3D Modeling

## Component Hierarchy

```
App.tsx (Root)
    â”œâ”€â”€ ProjectsDrawer
    â”‚   â””â”€â”€ [Project List]
    â”‚
    â””â”€â”€ ProjectModel (3D Viewer)
        â”‚
        â”œâ”€â”€ Header
        â”‚   â”œâ”€â”€ Project Name
        â”‚   â””â”€â”€ Element Count
        â”‚
        â”œâ”€â”€ Toolbar
        â”‚   â”œâ”€â”€ [Draw Line] Button
        â”‚   â”œâ”€â”€ [Cancel] Button (conditional)
        â”‚   â””â”€â”€ [Deselect] Button (conditional)
        â”‚
        â”œâ”€â”€ Canvas (React Three Fiber)
        â”‚   â”‚
        â”‚   â”œâ”€â”€ Lighting
        â”‚   â”‚   â”œâ”€â”€ Ambient Light
        â”‚   â”‚   â”œâ”€â”€ Directional Light (with shadows)
        â”‚   â”‚   â””â”€â”€ Point Light
        â”‚   â”‚
        â”‚   â”œâ”€â”€ Environment (city preset)
        â”‚   â”‚
        â”‚   â”œâ”€â”€ Grid (20x20, 1m cells)
        â”‚   â”‚
        â”‚   â”œâ”€â”€ DrawingPlane (invisible click detector)
        â”‚   â”‚
        â”‚   â”œâ”€â”€ DrawingPreview (conditional, when drawing)
        â”‚   â”‚   â”œâ”€â”€ Dashed Line
        â”‚   â”‚   â”œâ”€â”€ Start Point Sphere
        â”‚   â”‚   â””â”€â”€ End Point Sphere
        â”‚   â”‚
        â”‚   â”œâ”€â”€ StructuralElement3D (for each element)
        â”‚   â”‚   â”œâ”€â”€ Main Mesh (box geometry)
        â”‚   â”‚   â”œâ”€â”€ Selection Outline (conditional, when selected)
        â”‚   â”‚   â”œâ”€â”€ Node Spheres (x2, at ends)
        â”‚   â”‚   â”œâ”€â”€ Support Indicators (for each support)
        â”‚   â”‚   â”‚   â”œâ”€â”€ Support Sphere
        â”‚   â”‚   â”‚   â””â”€â”€ Support Cone (direction)
        â”‚   â”‚   â””â”€â”€ Text Labels
        â”‚   â”‚       â”œâ”€â”€ Element Name
        â”‚   â”‚       â””â”€â”€ Section Name
        â”‚   â”‚
        â”‚   â””â”€â”€ OrbitControls (camera navigation)
        â”‚
        â”œâ”€â”€ Footer (controls info)
        â”‚
        â”œâ”€â”€ ContextMenu3D (conditional, on right-click)
        â”‚   â”œâ”€â”€ [Edit Element] Button
        â”‚   â”œâ”€â”€ [Duplicate] Button
        â”‚   â””â”€â”€ [Delete] Button
        â”‚
        â””â”€â”€ ElementEditPanel (conditional, when editing)
            â”œâ”€â”€ Header (with close button)
            â”œâ”€â”€ Basic Info Section
            â”œâ”€â”€ Position & Orientation Section
            â”œâ”€â”€ Section Info Section
            â”œâ”€â”€ Supports Summary
            â”œâ”€â”€ Loads Summary
            â””â”€â”€ Footer Actions
                â”œâ”€â”€ [Save Changes] Button
                â”œâ”€â”€ [Delete] Button
                â””â”€â”€ [Cancel] Button
```

---

## Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER ACTIONS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚            â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
              â”‚   Click   â”‚ â”‚Right-  â”‚ â”‚  Draw    â”‚
              â”‚  Element  â”‚ â”‚Click   â”‚ â”‚  Line    â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                    â”‚           â”‚            â”‚
                    â”‚           â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚           â”‚            â”‚                      â”‚
â”‚  ProjectModel Component (Local State)                            â”‚
â”‚                   â”‚           â”‚            â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ selectedElement      â”‚    â”‚    â”‚  drawingState    â”‚          â”‚
â”‚  â”‚ (Element | null)     â”‚    â”‚    â”‚  - isDrawing     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  - startPoint    â”‚          â”‚
â”‚                   â”‚           â”‚    â”‚  - currentPoint  â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”‚    â”‚  - previewLine   â”‚          â”‚
â”‚  â”‚ isEditPanelOpen      â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â”‚ (boolean)            â”‚    â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                   â”‚
â”‚                               â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ contextMenu                           â”‚                       â”‚
â”‚  â”‚  - isOpen: boolean                    â”‚                       â”‚
â”‚  â”‚  - position: { x, y }                 â”‚                       â”‚
â”‚  â”‚  - element: Element | null            â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ localProject (working copy)                    â”‚              â”‚
â”‚  â”‚  - id                                          â”‚              â”‚
â”‚  â”‚  - name                                        â”‚              â”‚
â”‚  â”‚  - elements: Element[]                         â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ id                                    â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ name                                  â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ type                                  â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ span                                  â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ position?: [x, y, z]                 â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ rotation?: degrees                   â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ sections: SectionProperties[]        â”‚              â”‚
â”‚  â”‚      â”œâ”€â”€ supports: Support[]                  â”‚              â”‚
â”‚  â”‚      â””â”€â”€ appliedLoads: AppliedLoads[]         â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  onUpdateProject()     â”‚
                    â”‚  (callback to parent)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                    â”‚
â”‚  App.tsx Component (Global State)                                 â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ projects: Project[]                            â”‚               â”‚
â”‚  â”‚  (source of truth)                             â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ selectedProject: Project | null                â”‚               â”‚
â”‚  â”‚  (synchronized with projects array)            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  isFirebaseConfigured  â”‚
                 â”‚  & user authenticated? â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”          â”Œâ”€â”€â–¼â”€â”€â”€â”
                â”‚  YES  â”‚          â”‚  NO  â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”¬â”€â”€â”€â”˜
                    â”‚                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
        â”‚ projectService       â”‚      â”‚
        â”‚ .updateProject()     â”‚      â”‚
        â”‚                      â”‚      â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
        â”‚ â”‚ Save to Firebase â”‚ â”‚      â”‚
        â”‚ â”‚ (async)          â”‚ â”‚      â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                    â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Update Complete  â”‚
                    â”‚ 3D View Re-renderâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Event Flow: Drawing a Line

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: User Clicks "Draw Line" Button                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ toggleDrawingMode() â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ isDrawingMode = true         â”‚
            â”‚ OrbitControls disabled       â”‚
            â”‚ UI updates (button highlight)â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: User Clicks on Ground (First Point)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ handlePlaneClick()  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ startDrawing(point) â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ drawingState.isDrawing = trueâ”‚
            â”‚ drawingState.startPoint = pt â”‚
            â”‚ Green sphere appears         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: User Moves Mouse                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ handlePlaneMove()   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ updateDrawing(point)â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ drawingState.previewLine    â”‚
            â”‚   = { start, end }          â”‚
            â”‚ Dashed line previews        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: User Clicks Again (Second Point)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ handlePlaneClick()  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ finishDrawing(point)â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Returns { start, end }          â”‚
            â”‚ Clears drawing state            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ createElementFromLine(start, end)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Calculate:                           â”‚
        â”‚  - span = start.distanceTo(end)     â”‚
        â”‚  - midPoint = (start + end) / 2     â”‚
        â”‚  - angle = atan2(dir.z, dir.x)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Create newElement:                   â”‚
        â”‚  - id: `element-${timestamp}`       â”‚
        â”‚  - name: "Element [N]"              â”‚
        â”‚  - type: "Beam"                     â”‚
        â”‚  - span: calculated                 â”‚
        â”‚  - position: midPoint               â”‚
        â”‚  - rotation: angle                  â”‚
        â”‚  - sections: default LVL            â”‚
        â”‚  - supports: 2 pinned               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ updatedProject = {                   â”‚
        â”‚   ...localProject,                  â”‚
        â”‚   elements: [...elements, newElem]  â”‚
        â”‚ }                                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ setLocalProject()   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ onUpdateProject()   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ toggleDrawingMode() â”‚
                â”‚ (exit drawing mode) â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 3D View Re-renders                   â”‚
        â”‚ New element appears!                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Event Flow: Right-Click Context Menu

```
User Right-Clicks on Element
        â”‚
        â–¼
StructuralElement3D.onContextMenu
        â”‚
        â”œâ”€â–º event.stopPropagation()
        â””â”€â–º handleElementContextMenu(element, event)
                â”‚
                â–¼
        setContextMenu({
          isOpen: true,
          position: { x: clientX, y: clientY },
          element: element
        })
                â”‚
                â–¼
        ContextMenu3D renders at cursor
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       â”‚       â”‚
        â–¼       â–¼       â–¼
     [Edit] [Duplicate] [Delete]
        â”‚       â”‚       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â–º User clicks option
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       â”‚            â”‚
   handleEdit  handleDuplicate  handleDelete
        â”‚       â”‚            â”‚
        â–¼       â–¼            â–¼
  Open Panel  Create Copy  Confirm & Remove
        â”‚       â”‚            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â–º onClose()
                â”‚
                â–¼
        ContextMenu closes
```

---

## State Synchronization Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SYNCHRONIZATION CYCLE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Local State (ProjectModel)
    â”‚
    â”œâ”€â–º User edits element in Edit Panel
    â”‚       â”‚
    â”‚       â–¼
    â”‚   setLocalProject({ ...project, elements: updated })
    â”‚       â”‚
    â”‚       â–¼
    â”‚   onUpdateProject(updatedProject)  â—„â”€â”€â”€ Callback to parent
    â”‚       â”‚
    â”‚       â–¼
    â””â”€â–º App.tsx receives update
            â”‚
            â”œâ”€â–º setProjects(prev => prev.map(p => ...))
            â”‚       â”‚
            â”‚       â””â”€â–º Global projects array updated
            â”‚
            â”œâ”€â–º setSelectedProject(updatedProject)
            â”‚       â”‚
            â”‚       â””â”€â–º Selected project synced
            â”‚
            â””â”€â–º projectService.updateProject()  (if Firebase)
                    â”‚
                    â””â”€â–º Cloud persistence
                            â”‚
                            â–¼
                    ProjectModel re-renders
                            â”‚
                            â–¼
                    useEffect detects project change
                            â”‚
                            â–¼
                    setLocalProject(project)
                            â”‚
                            â””â”€â–º Sync complete! âœ…
```

---

## 3D Rendering Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RENDERING PIPELINE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

React Component Tree
    â”‚
    â”œâ”€â–º ProjectModel
    â”‚       â”‚
    â”‚       â”œâ”€â–º Canvas (R3F)
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â–º Lights (ambient, directional, point)
    â”‚       â”‚       â”‚       â”‚
    â”‚       â”‚       â”‚       â””â”€â–º Shadow mapping enabled
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â–º Environment (city preset)
    â”‚       â”‚       â”‚       â”‚
    â”‚       â”‚       â”‚       â””â”€â–º IBL textures loaded
    â”‚       â”‚       â”‚
    â”‚       â”‚       â”œâ”€â–º Grid (20x20 plane)
    â”‚       â”‚       â”‚       â”‚
    â”‚       â”‚       â”‚       â””â”€â–º Rendered to ground plane
    â”‚       â”‚       â”‚
    â”‚       â”‚       â””â”€â–º Elements (via map)
    â”‚       â”‚               â”‚
    â”‚       â”‚               â”œâ”€â–º StructuralElement3D (1)
    â”‚       â”‚               â”œâ”€â–º StructuralElement3D (2)
    â”‚       â”‚               â””â”€â–º StructuralElement3D (N)
    â”‚       â”‚                       â”‚
    â”‚       â”‚                       â”œâ”€â–º BoxGeometry (main mesh)
    â”‚       â”‚                       â”‚       â”‚
    â”‚       â”‚                       â”‚       â””â”€â–º MeshStandardMaterial
    â”‚       â”‚                       â”‚
    â”‚       â”‚                       â”œâ”€â–º Selection Outline (conditional)
    â”‚       â”‚                       â”‚
    â”‚       â”‚                       â”œâ”€â–º Node Spheres (x2)
    â”‚       â”‚                       â”‚       â”‚
    â”‚       â”‚                       â”‚       â””â”€â–º SphereGeometry + Material
    â”‚       â”‚                       â”‚
    â”‚       â”‚                       â”œâ”€â–º Support Indicators
    â”‚       â”‚                       â”‚       â”‚
    â”‚       â”‚                       â”‚       â”œâ”€â–º Support Sphere
    â”‚       â”‚                       â”‚       â””â”€â–º Support Cone
    â”‚       â”‚                       â”‚
    â”‚       â”‚                       â””â”€â–º Text Labels
    â”‚       â”‚                               â”‚
    â”‚       â”‚                               â”œâ”€â–º Element Name
    â”‚       â”‚                               â””â”€â–º Section Name
    â”‚       â”‚
    â”‚       â””â”€â–º OrbitControls
    â”‚               â”‚
    â”‚               â””â”€â–º Camera manipulation
    â”‚
    â””â”€â–º DOM Overlays (React)
            â”‚
            â”œâ”€â–º Header
            â”œâ”€â–º Toolbar
            â”œâ”€â–º Footer
            â”œâ”€â–º ContextMenu3D (conditional)
            â””â”€â–º ElementEditPanel (conditional)

Final Output:
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GPU renders WebGL scene               â”‚
â”‚  â”œâ”€â–º Shadow pass                       â”‚
â”‚  â”œâ”€â–º Color pass                        â”‚
â”‚  â”œâ”€â–º Post-processing (if any)          â”‚
â”‚  â””â”€â–º Composited to canvas              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
Display on Screen! ğŸ–¥ï¸
```

---

## Interaction Detection Flow

```
User Clicks on 3D Element
    â”‚
    â–¼
Three.js Raycasting
    â”‚
    â”œâ”€â–º Cast ray from camera through cursor
    â”‚
    â”œâ”€â–º Check intersection with all meshes
    â”‚
    â””â”€â–º Find closest intersected object
            â”‚
            â”œâ”€â–º No intersection
            â”‚       â”‚
            â”‚       â””â”€â–º onPointerMissed (deselect)
            â”‚
            â””â”€â–º Intersection found
                    â”‚
                    â”œâ”€â–º Get mesh userData/props
                    â”‚
                    â”œâ”€â–º Trigger mesh.onClick
                    â”‚
                    â””â”€â–º Bubble up to StructuralElement3D
                            â”‚
                            â”œâ”€â–º stopPropagation()
                            â”‚
                            â””â”€â–º onSelect(element)
                                    â”‚
                                    â””â”€â–º setSelectedElement(element)
```

---

**This diagram shows the complete architecture of your interactive 3D system!** ğŸ‰

Save this for reference when extending functionality or debugging issues.
